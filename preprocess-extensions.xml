<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." name="preprocess-map-first">
  
  <!-- ==========================================
       DITA Community Map-First Preprocessing
       
       Rearchitects the Open Toolkit preprocessing pipeline
       to do all map processing first, then do processing
       of topics to resolve conrefs, apply filtering,
       and create temporary topic files reflecting any
       copy-to and chunking defined in the map.
       
       NOTE: Making the explicit decision to not include
             the preprocessing pre and post extension
             points from the base build_preprocess_template.xml
             as Jarno does not like these extension points
             and it adds complexity that is probably not
             warranted.
       
       ========================================== -->
  
    <!-- Get the OT configuration properties so we can then
         pass them as parameters or system properties to
         operations.
      -->
    <loadproperties srcfile="${dita.dir}/lib/configuration.properties"/>  
  
    <!-- Create stub targets for those targets that
         are not in both 1.8.5 and 2.x:
         
         The real versions of these targets should
         be used when they are present because
         they occur earlier in the build file
         precedence order.
      -->
  <!-- 2.x Only: -->
    <target name="preprocess.init"/>
    <target name="move-meta-entries"/>
    <target name="clean-map"/>
    <target name="profile"/>
    <target name="topic-fragment"/>
  
  <!-- 1.8.5 Only: -->
  
    <target name="move-links"/>
  
  
  <!-- DITA Community versions of the base preprocessing targets. 
    
       These add the adjust-copy-to extensions.
       
       Note that the copy-to adjustment requires repeating many of 
       the prior preprocessing steps to then reflect the adjusted
       copy-to values.
    -->
  
    <target name="dc-preprocess" 
      description="DITA Community preprocessing"
      depends="dc-preprocess-1.8.5, dc-preprocess-2.x, dc-preprocess-unsupported-version"
    />
  
    <condition property="isOT1.8.5">
      <equals arg1="${otversion}" arg2="1.8.5"/>
    </condition>
    <condition property="isOT2.x">
      <matches string="${otversion}" pattern="^2\."/>
    </condition>
  
    <condition property="isOTUnknown">
      <not>
        <or>
          <equals arg1="${otversion}" arg2="1.8.5"/>
          <matches string="${otversion}" pattern="^2\."/>
        </or>
      </not>
    </condition>
    
  
    <target name="dc-preprocess-1.8.5" if="isOT1.8.5"
      description="DITA Community preprocessing for OT 1.8.5"
      depends="
                gen-list,
                debug-filter,
                copy-files,
                conrefpush,
                conref,
                move-meta-entries,
                keyref,
                coderef,
                mapref,
                mappull,
                dc-adjust-copy-to,
                chunk,
                maplink,
                move-links,
                topicpull,
                flag-module"
      >
    </target>
  
      <!-- FIXME: Not yet modified for preprocess extensions -->
    <target name="dc-preprocess-2.x" if="isOT2.x"
      description="DITA Community preprocessing for OT 2.x"
      depends="
                  preprocess.init,
                  gen-list,
                  debug-filter,
                  mapref,
                  branch-filter,
                  copy-files,
                  keyref,
                  conrefpush,
                  conref,
                  profile,
                  topic-fragment,
                  coderef,
                  move-meta-entries,
                  chunk,
                  maplink,
                  topicpull,
                  flag-module,
                  clean-map"
      >
    </target>
  
  
    <target name="dc-preprocess-map-first" 
      description="DITA Community map-first preprocessing"
      depends="
                gen-list,
                debug-filter,
                copy-files,
                conrefpush,
                conref,
                move-meta-entries,
                keyref,
                coderef,
                mapref,
                mappull,
                dc-adjust-copy-to,
                copy-files,
                conrefpush,
                conref,
                move-meta-entries,
                keyref,
                coderef,
                mapref,
                mappull,
                chunk,
                maplink,
                move-links,
                topicpull,
                flag-module"
      >
      <!-- This target replaces the base OT preprocess. 
      
           
      -->
    </target>
    
    <target name="dc-preprocess-unsupported-version" if="isOTUnknown"
      depends="preprocess"
      >
      <echo> - [WARN] Unsupported Open Toolkit version "${otversion}". Using base preprocessing.</echo>
    </target>

</project>